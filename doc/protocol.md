# Source Engine Protocol

Since I couldn't find any decent documentation of the Source engine protocol online, I decided to make my own unofficial documentation. Hopefully everything here will continue to improve over time. ~Breadpudding

# Protocol Details

The TF2 server uses a UDP socket for communication with a default port of 27015. UDP messages are no larger than 1400 bytes.

# Types

All types larger than a byte is stored in the little endian format.

| Valve       | C           | Rust        |
| ----------- | ----------- | ----------- |
| `byte`      | `uint8_t`   | `u8`        |
| `short`     | `int16_t`   | `i16`       |
| `long`      | `int32_t`   | `i32`       |
| `float`     | `float`     | `f32`       |
| `long long` | `uint64_t`  | `u64`       |
| `string`    | *See Below* | *See Below* |

## Strings

All strings handled by the Source engine are zero-terminated UTF-8 strings.

# List of Source messages

## A2A_ACK

Responds to: `A2A_PING`

Type: `j`

| Name    | Type     | Description            | Value             |
| ------- | -------- | ---------------------- | ----------------- |
| Payload | `string` | Seemingly useless data | `000000000000000` |

## M2A_ACTIVEMODS

Type: `y`

TODO

## M2A_ACTIVEMODS3

Type: `P`

TODO

## S2C_AUTHCHALLENGE1

Type: `4`

TODO

## S2C_AUTHCHALLENGE2

Type: `5`

TODO

## S2C_AUTHCOMPLETE

Type: `6`

TODO

## C2S_AUTHCONNECT

Type: `7`

TODO

## C2S_AUTHREQUEST1

Type: `3`

TODO

## S2C_CHALLENGE

Responds to: `A2S_PLAYER`, `A2S_RULES`, `A2S_SERVERQUERY_GETCHALLENGE`

Responds with: `A2S_PLAYER`, `A2S_RULES`

Type: `A`

| Name      | Type   | Description                                  | Value    |
| --------- | ------ | -------------------------------------------- | -------- |
| Challenge | `long` | The challenge number generated by the server | *Varies* |

OR (STEAM ONLY) (FROM A2S_GETCHALLENGE)

| Name                  | Type        | Description                                                   | Value                                                                   |
|-----------------------|-------------|---------------------------------------------------------------|-------------------------------------------------------------------------|
| Magic Version         | `long`      | A number to check if the client is running the same version   | *Unknown*                                                               |
| Challenge             | `long`      | Server to client challenge                                    | *Varies*                                                                |
| Client Challenge      | `long`      | The client ot server challenge (`long` from A2S_GETCHALLENGE) | *Varies*                                                                |
| Auth Protocol         | `long`      | The way the client authenticates with the server              | `0x02` for hashed CD key (Not allowed in multiplayer), `0x03` for Steam |
| Steam2 Encryption Key | `short`     | No longer is used                                             | `0`                                                                     |
| Steam ID              | `long long` | The users Steam ID converted to a u64                         | *Varies*                                                                |
| SteamServer Secure    | `byte`      | If the server is secure (UNCERTAIN)                           | `0` or `1`                                                              |
| Padding Bytes         | `string`    | Padding                                                       | `000000`                                                                |

### Generating the challenge number
A random number is generated and **must** be passed through a CRC32 hash before entering the field here

## C2M_CHECKMD5

Type: `M`

TODO

## C2S_CONNECT

Type: `k`

| Name             | Type     | Description                                      | Value                                                                   |
|------------------|----------|--------------------------------------------------|-------------------------------------------------------------------------|
| Protocol Version | `long`   | The protocol version of the client               | Unknown                                                                 |
| Auth Protocol    | `long`   | The way the client authenticates witht he server | `0x02` for hashed CD key (Not allowed in multiplayer), `0x03` for Steam |
| Challenge Number | `long`   | The challenge (TODO find more info)              |                                                                         |
| Retry Challenge  | `long`   | TODO                                             |                                                                         |
| Client Name      | `string` | The name of client (TODO)                        |                                                                         |
| Password         | `string` | Contents of the password convar on the client    | *Varies*                                                                |
| Product Version  | `string` | Product version from steam                       | *Unknown*                                                               |

## S2C_CONNECTION

Type: `B`

| Name             | Type     | Description                                       | Value        |
|------------------|----------|---------------------------------------------------|--------------|
| Client Challenge | `long`   | The clients challenge (With extra verification??) | *Varies*     |
| Padding          | `string` | Padding                                           | `0000000000` |

OR

| Name    | Type     | Description | Value              |
|---------|----------|-------------|--------------------|
| Padding | `string` | Padding???  | `00000000000000` |

## S2C_CONNREJECT

Type: `9`

Sometimes caused by spoofing

| Name             | Type     | Description                  | Value    |
|------------------|----------|------------------------------|----------|
| Client Challenge | `long`   | The clients challenge        | *Varies* |
| Reason           | `string` | The reason for the rejection | *Varies* |

## A2A_CUSTOM

Type: `t`

TODO

## A2M_GET_MOTD

Type: `g`

TODO

## A2M_GET_SERVERS

Type: `c`

TODO

## A2M_GET_SERVERS_BATCH

Type: `e`

TODO

## A2M_GET_SERVERS_BATCH2

Type: `1`

TODO

## A2M_GETACTIVEMODS

Type: `x`

TODO

## A2M_GETACTIVEMODS2

Type: `2`

TODO

## A2M_GETACTIVEMODS3

Type: `Q`

TODO

## A2S_GETCHALLENGE

Type: `q`

| Name            | Type     | Description | Value        |
|-----------------|----------|-------------|--------------|
| Retry Challenge | `long`   | TODO        | TODO         |
| Padding         | `string` | Padding     | `0000000000` |

## S2M_GETFILE

Type: `J`

TODO

## A2M_GETMASTERSERVERS

Type: `v`

TODO

## A2S_INFO

Responds with: `S2A_INFO_GOLDSRC` or `S2A_INFO_SRC`

Type: `T`

| Name    | Type     | Description | Value                 |
| ------- | -------- | ----------- | --------------------- |
| Payload | `string` | N/A         | `Source Engine Query` |

## S2A_INFO_DETAILED

Type: `m`

TODO

## S2A_INFO_GOLDSRC

Responds to: `A2S_INFO`

Type: `m`

TODO

## S2A_INFO_SRC

Responds to: `A2S_INFO`

Type: `I`

| Name        | Type     | Description                                | Value           |
| ----------- | -------- | ------------------------------------------ | --------------- |
| Protocol    | `byte`   | Protocol version of the server             | *Unknown*       |
| Name        | `string` | Name of the server                         | *Varies*        |
| Map         | `string` | Current map used on the server             | *Varies*        |
| Folder      | `string` | Name of the folder with the game resources | `tf`            |
| Game        | `string` | Name of the game loaded by the server      | `Team Fortress` |
| ID          | `short`  | Steam App ID of the game                   | `440`           |
| Players     | `byte`   | Number of players current using the server | *Varies*        |
| Maxplayers  | `byte`   | Maximum number of players you can join     | *Varies*        |
| Bots        | `byte`   | Number of bots on the server               | *Should be 0*   |
| Server type | `byte`   | The type of server being used              | `d`, `l` or `p` |
| Environment | `byte`   | The operating system the server is using   | `m`, `l` or `w` |
| Visibility  | `byte`   | Whether the server is password protected   | `0` or `1`      |
| VAC Support | `byte`   | Whether the server uses Valve Anti-Cheat   | `0` or `1`      |
| Version     | `string` | Version of the game running                | *Varies*        |
| Extra Data  | `byte`   | A bitfield specifying additional info      | *Varies*        |

### Server Type

| Symbol | Meaning              |
| ------ | -------------------- |
| `d`    | Dedicated Server     |
| `l`    | Non-Dedicated Server |
| `p`    | SourceTV Relay       |

### Environment

| Symbol     | Meaning |
| ---------- | ------- |
| `m` or `o` | macOS   |
| `l`        | Linux   |
| `w`        | Windows |

### Extra Data

The following is listed in the order it would appear in the message.

#### EDF & 0x80

| Name | Type    | Description                       | Value    |
| ---- | ------- | --------------------------------- | -------- |
| Port | `short` | The port the server is running on | *Varies* |

#### EDF & 0x10

| Name    | Type        | Description          | Value    |
| ------- | ----------- | -------------------- | -------- |
| SteamID | `long long` | The server's SteamID | *Varies* |

#### EDF & 0x40

| Name | Type     | Description                | Value    |
| ---- | -------- | -------------------------- | -------- |
| Port | `short`  | Port for SourceTV          | *Varies* |
| Name | `string` | Name of the SourceTV relay | *Varies* |

#### EDF & 0x20

| Name     | Type     | Description                        | Value    |
| -------- | -------- | ---------------------------------- | -------- |
| Keywords | `string` | Whatever the value of `sv_tags` is | *Varies* |

#### EDF & 0x01

| Name   | Type        | Description                           | Value |
| ------ | ----------- | ------------------------------------- | ----- |
| GameID | `long long` | The 64-bit variant of the Steam AppID | `440` |

## M2C_ISVALIDMD5

Type: `N`

TODO

## S2A_LOGSTRING

Type: `R`

| Name | Type     | Description            | Value    |
|------|----------|------------------------|----------|
| Data | `string` | A single string to log | *Varies* |

## S2A_LOGSTRING2

Type: `S`

| Name | Type     | Description                                 | Value    |
|------|----------|---------------------------------------------|----------|
| Data | `string` | Output of combining sv\_logsecret + a string (format!("{}{}", sv\_logsecret, string") | *Varies* |

## M2A_MASTERSERVERS

Type: `w`

TODO

## C2C_MOD

Type: `X`

TODO

## M2A_MOTD

Type: `h`

TODO

## M2M_MSG

Type: `z`

TODO

## A2A_PING

Responds with: `A2A_ACK`

Type: `i`

*There is no additional data in this message*

## A2S_PING2

Type: `Y`

TODO

## S2A_PING2REPLY

Type: `Z`

TODO

## A2S_PLAYER

Responds to: `S2C_CHALLENGE`

Responds with: `S2C_CHALLENGE`, `S2A_PLAYER`

Type: `U`

| Name      | Type   | Description                                    | Value    |
| --------- | ------ | ---------------------------------------------- | -------- |
| Challenge | `long` | Either the challenge number or `-1` to get one | *Varies* |

## S2A_PLAYER

Responds to: `A2S_PLAYER`

Type: `D`

| Name    | Type   | Description       | Value    |
| ------- | ------ | ----------------- | -------- |
| Players | `byte` | Number of players | *Varies* |

For each player, a player chunk follows.

### Player Chunk

| Name     | Type     | Description                                      | Value    |
| -------- | -------- | ------------------------------------------------ | -------- |
| Index    | `byte`   | Player chunk index starting at 0                 | *Varies* |
| Name     | `string` | Name of the player                               | *Varies* |
| Score    | `long`   | The player's score                               | *Varies* |
| Duration | `float`  | How long(in seconds) a player has been connected | *Varies* |

## A2A_PRINT

Type: `l`

| Name    | Type     | Description | Value                      |
|---------|----------|-------------|----------------------------|
| Message | `string` | A message   | `Banned by the server\n` |

OR

NOTE: This appears to be used to send players to other servers

| Name            | Type     | Description                   | Value    |
|-----------------|----------|-------------------------------|----------|
| Redirect Buffer | `string` | A IP address/port (UNCERTAIN) | *Varies* |

## A2S_RCON

Type: `r`

TODO

## S2C_REDIRECT

Type: `L`

| Name        | Type     | Description                                             | Value            |
|-------------|----------|---------------------------------------------------------|------------------|
| IP and port | `string` | The IP and port of the server to redirect the client to | `x.x.x.x:port` |

## A2S_RULES

Responds to: `S2C_CHALLENGE`

Responds with: `S2C_CHALLENGE`, `S2A_RULES`

Type: `V`

| Name      | Type   | Description                                    | Value    |
| --------- | ------ | ---------------------------------------------- | -------- |
| Challenge | `long` | Either the challenge number or `-1` to get one | *Varies* |

## S2A_RULES

Responds to: `A2S_RULES`

Type: `E`

| Name  | Type    | Description     | Value    |
| ----- | ------- | --------------- | -------- |
| Rules | `short` | Number of rules | *Varies* |

For each rule, a rule chunk follows.

### Rule chunk

| Name  | Type     | Description       | Value    |
| ----- | -------- | ----------------- | -------- |
| Name  | `string` | Name of the rule  | *Varies* |
| Value | `string` | Value of the rule | *Varies* |

## M2S_SENDFILE

Type: `K`

TODO

## A2S_SERVERQUERY_GETCHALLENGE

Responds with: `S2C_CHALLENGE`

Type: `W`

| Name      | Type   | Description                                    | Value    |
| --------- | ------ | ---------------------------------------------- | -------- |
| Challenge | `long` | Either the challenge number or `-1` to get one | *Varies* |

## M2A_SERVER_BATCH

Type: `f`

| Name                | Type       | Description                                | Value |
|---------------------|------------|--------------------------------------------|-------|
| Next Unique ID      | `long`    | Next unique id, -1 for last batch          | ?     |
| 6 byte IP/port list | `byte * 6` | A list of IP/port combinations for servers | ?     |

## M2A_SERVERS

Type: `d`

| Name                | Type       | Description                                | Value |
|---------------------|------------|--------------------------------------------|-------|
| 6 byte IP/port list | `byte * 6` | A list of IP/port combinations for servers | ?     |
